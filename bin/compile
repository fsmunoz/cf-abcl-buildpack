#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
BUILD_DIR=$1
CACHE_DIR=$2

echo "=== Starting compile, build: $BUILD_DIR ; cache: $CACHE_DIR"

# Load common JVM functionality from https://github.com/heroku/heroku-buildpack-jvm-common
JVM_COMMON_BUILDPACK=https://heroku-jvm-common.s3.amazonaws.com/jvm-buildpack-common.tar.gz
curl --silent --location $JVM_COMMON_BUILDPACK | tar -x bin/java -zO > /tmp/jvm-common
source /tmp/jvm-common

# JDK version
if [ -z "$JAVA_VERSION" ]; then # could be set using user_env_compile
    if [ -f "${BUILD_DIR}/system.properties" ]; then
        JAVA_VERSION=$(get_app_system_value ${BUILD_DIR}/system.properties "java.runtime.version")
    else
        JAVA_VERSION=$DEFAULT_JDK_VERSION
    fi
fi

# Install JDK
if [ "$(is_supported_java_version ${JAVA_VERSION})" = "true" ]; then
    echo -n "-----> Installing OpenJDK ${JAVA_VERSION}..."
    install_java ${BUILD_DIR} ${JAVA_VERSION}
    jdk_overlay ${BUILD_DIR}
    echo "done"
else
    echo " !     Unsupported Java version: $JAVA_VERSION"
    exit 1
fi

# Make sure new JDK is visible
export PATH="$HOME/app/.jdk/bin:$HOME/.jdk/bin:$PATH"


ABCL_JAR_URL="https://common-lisp.net/project/armedbear/releases/current/abcl.jar"
ABCL_JAR_PATH="$CACHE_DIR/abcl.jar"
ABCL_CONTRIB_JAR_URL="https://common-lisp.net/project/armedbear/releases/current/abcl-contrib.jar"
ABCL_CONTRIB_JAR_PATH="$CACHE_DIR/abcl-contrib.jar"

if [ ! -r "$ABCL_JAR_PATH" ]; then
    echo "-----> Downloading ABCL"
    echo "       Downloading abcl.jar"
    mkdir -p $(dirname $ABCL_JAR_PATH)
    curl --silent --show-error --max-time 120 -L -o $ABCL_JAR_PATH $ABCL_JAR_URL
    echo "       Downloading abcl-contrib.jar"
    curl --silent --show-error --max-time 120 -L -o $ABCL_CONTRIB_JAR_PATH $ABCL_CONTRIB_JAR_URL
else
    echo "-----> Using cached ABCL jars"
fi

### Quicklisp
QUICKLISP_URL="https://beta.quicklisp.org/quicklisp.lisp"
QUICKLISP_PATH="$CACHE_DIR/quicklisp.lisp"
echo "-----> Downloading Quicklisp"
curl --silent --show-error --max-time 120 -L -o $QUICKLISP_PATH  $QUICKLISP_URL

echo "-----> Getting system from ASDF: $SYSTEM"
SYSTEM=$(awk '/asdf:defsystem/ {gsub("#:","");print $2}' $BUILD_DIR/*.asd 2>/dev/null)

echo "----> DIR CONTENTS"
ls -larth $BUILD_DIR

echo "-----> Building init script"
INIT=$BUILD_DIR/.init.lisp
USER_INIT=$BUILD_DIR/cf-setup.lisp

cat > $INIT <<EOF
(load "$QUICKLISP_PATH")
(quicklisp-quickstart:install)
(require :abcl-contrib)
(load "$USER_INIT")
EOF

echo "init script is:"
cat $INIT


#JAVA=$(which java)
#ABCL="$JAVA -server -Xrs -cp $ABCL_JAR_PATH:$ABCL_CONTRIB_JAR_PATH org.armedbear.lisp.Main"


echo "-----> Building shared vars file"
ABCL_BIN=$BUILD_DIR/abcl
JAVA=$(which java)
JVM_OPTS="-server -Xrs -Xmx400m"
ABCL="$JAVA $JVM_OPTS: -cp $ABCL_JAR_PATH:$ABCL_CONTRIB_JAR_PATH org.armedbear.lisp.Main --load $INIT"

cat > $ABCL_BIN <<EOF
#!/bin/sh
exec $ABCL
EOF

echo "-----> Script is:"
cat $ABCL_BIN
chmod a+x $ABCL_BIN
$ABCL_BIN

echo "-----> END OF COMPILE"

